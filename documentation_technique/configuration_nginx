# ğŸ” Redirection HTTP vers HTTPS
server {
    listen 80; # Ã‰coute sur le port HTTP
    listen [::]:80; # Ã‰coute en IPv6 aussi sur le port HTTP
    server_name _; # "_" signifie : pour nâ€™importe quel nom de domaine

    return 301 https://$host$request_uri; # Redirige tout le trafic HTTP vers HTTPS
}

# ğŸ”’ HTTPS (sÃ©curisÃ©)
server {
    listen 443 ssl; # Ã‰coute sur le port HTTPS (IPv4)
    listen [::]:443 ssl; # Ã‰coute sur le port HTTPS (IPv6)
    server_name _;  # "_" = valeur par dÃ©faut si aucun autre "server_name" ne correspond

    # ğŸ“„ Certificat SSL avec Let's Encrypt
    ssl_certificate /etc/letsencrypt/live/lasicroom.duckdns.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/lasicroom.duckdns.org/privkey.pem;

    # ğŸ“‚ Racine du site (build React dÃ©jÃ  compilÃ©)
    root /home/arnaud/Bureau/lasicroom_projet_fil_rouge/lasicroom_front/build;
    index index.html; # Fichier par dÃ©faut Ã  servir si aucun fichier nâ€™est spÃ©cifiÃ©

    # ğŸ” Politique CSP (Content Security Policy)
    # Restreint les sources de scripts, styles, images, etc. pour limiter les attaques XSS
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-src 'self' https://www.youtube.com https://widget.deezer.com; media-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none';" always;

    # ğŸ”’ Autres en-tÃªtes de sÃ©curitÃ©
    add_header X-Content-Type-Options "nosniff" always; # EmpÃªche l'interprÃ©tation incorrecte du type MIME
    add_header X-Frame-Options "DENY" always; # Interdit lâ€™intÃ©gration du site dans une iframe
    add_header X-XSS-Protection "1; mode=block" always; # Active lâ€™anti-XSS du navigateur
    add_header Referrer-Policy "strict-origin-when-cross-origin" always; # ContrÃ´le lâ€™envoi du header "Referer"
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always; # DÃ©sactive certaines API du navigateur


    # ğŸ“¦ Redirection du trafic vers lâ€™API backend Node.js (ex : Express)
    location /api/ {
        proxy_pass http://localhost:3001; # Redirige /api/ vers le backend Node.js
        proxy_http_version 1.1; # Utilise HTTP/1.1 pour maintenir les connexions
        proxy_set_header Host $host; # Passe lâ€™host du client
        proxy_set_header X-Real-IP $remote_addr;# Passe lâ€™IP rÃ©elle du client
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Passe la chaÃ®ne des IP
        proxy_set_header X-Forwarded-Proto $scheme; # Indique si HTTPS ou HTTP
    }

    # ğŸ–¼ï¸ Gestion des images uploadÃ©es (servies par le backend)
    location /photos_artistes/ {
        proxy_pass http://localhost:3001;
    }

    # ğŸŒ Gestion des routes React (SPA)
    # Si le fichier demandÃ© nâ€™existe pas (ex : /dashboard, /profile),
    # Nginx renvoie "index.html" pour que React gÃ¨re le routage cÃ´tÃ© client
    location / {
        try_files $uri /index.html;
    }
}
